# ğŸ—„ï¸ í˜¸í…” ì˜ˆì•½ ì‹œìŠ¤í…œ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„

## ERD ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Users   â”‚â”€â”€â”€â”€â”€â”€â”‚ Bookings â”‚â”€â”€â”€â”€â”€â”€â”‚  Rooms   â”‚
â”‚          â”‚1    Nâ”‚          â”‚N    1â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                  â”‚                 â”‚
     â”‚                  â”‚                 â”‚
     â”‚1                 â”‚1                â”‚1
     â”‚                  â”‚                 â”‚
     â”‚                  â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reviews  â”‚      â”‚ Payments â”‚      â”‚ Reviews  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ìš” í…Œì´ë¸” êµ¬ì¡°

### 1. users (ì‚¬ìš©ì)

```sql
CREATE TABLE users (
    id VARCHAR(15) PRIMARY KEY,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    nickname VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'USER',  -- USER, ADMIN
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ê´€ê³„**:
- `OneToMany` â†’ `bookings` (ì˜ˆì•½ ëª©ë¡)
- `OneToMany` â†’ `reviews` (ë¦¬ë·° ëª©ë¡)

**ì¸ë±ìŠ¤**:
- `email`: UNIQUE ì¸ë±ìŠ¤

---

### 2. rooms (ê°ì‹¤)

```sql
CREATE TABLE rooms (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description VARCHAR(1000) NOT NULL,
    type VARCHAR(50) NOT NULL,              -- ì‹±ê¸€, ë”ë¸”, ìŠ¤ìœ„íŠ¸ ë“±
    capacity INTEGER NOT NULL,
    price_per_night DECIMAL(10,2) NOT NULL,
    available BOOLEAN NOT NULL DEFAULT true, -- í™œì„±í™” ì—¬ë¶€
    status VARCHAR(20) NOT NULL DEFAULT 'CLEAN', -- CLEAN, DIRTY, MAINTENANCE
    status_updated_at TIMESTAMP,            -- ìƒíƒœ ë³€ê²½ ì‹œê°„
    image_url VARCHAR(500),
    view_type VARCHAR(50),                  -- ì˜¤ì…˜ë·°, ë§ˆìš´í‹´ë·°
    bed_count INTEGER
);
```

**í•µì‹¬ ì†ì„±**:

1. **`available`** (Boolean)
   - `true`: ê°ì‹¤ í™œì„±í™”, ì˜ˆì•½ ê°€ëŠ¥
   - `false`: ê°ì‹¤ ë¹„í™œì„±í™” (ë¦¬ëª¨ë¸ë§, ì¥ê¸° ë³´ìˆ˜)
   - ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì œì–´

2. **`status`** (RoomStatus)
   - `CLEAN`: ì²­ì†Œ ì™„ë£Œ ìƒíƒœ
   - `DIRTY`: ì²­ì†Œ í•„ìš” ìƒíƒœ (ì²´í¬ì•„ì›ƒ ì‹œ ìë™ ë³€ê²½)
   - `MAINTENANCE`: ë³´ìˆ˜ ì¤‘ ìƒíƒœ

**ê´€ê³„**:
- `OneToMany` â†’ `bookings` (ì˜ˆì•½ ëª©ë¡)
- `OneToMany` â†’ `reviews` (ë¦¬ë·° ëª©ë¡)

---

### 3. bookings (ì˜ˆì•½)

```sql
CREATE TABLE bookings (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(15) NOT NULL REFERENCES users(id),
    room_id BIGINT NOT NULL REFERENCES rooms(id),
    check_in_date DATE NOT NULL,
    check_out_date DATE NOT NULL,
    guests INTEGER NOT NULL,
    total_price DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'CONFIRMED', -- CONFIRMED, CHECKED_IN, CHECKED_OUT, CANCELLED
    special_requests VARCHAR(1000),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ì˜ˆì•½ ìƒíƒœ (BookingStatus)**:
- `CONFIRMED`: ì˜ˆì•½ í™•ì • (ì•„ì§ ì²´í¬ì¸ ì•ˆ í•¨)
- `CHECKED_IN`: ì²´í¬ì¸ ì™„ë£Œ (í˜„ì¬ íˆ¬ìˆ™ ì¤‘)
- `CHECKED_OUT`: ì²´í¬ì•„ì›ƒ ì™„ë£Œ
- `CANCELLED`: ì˜ˆì•½ ì·¨ì†Œ

**ìƒíƒœ ë³€ê²½ íë¦„**:
```
CONFIRMED â†’ CHECKED_IN â†’ CHECKED_OUT
    â†“
CANCELLED
```

**ê´€ê³„**:
- `ManyToOne` â†’ `user` (ì‚¬ìš©ì)
- `ManyToOne` â†’ `room` (ê°ì‹¤)
- `OneToOne` â†’ `payment` (ê²°ì œ)

**ì œì•½ì¡°ê±´**:
- `check_out_date > check_in_date` (ì²´í¬ì•„ì›ƒì€ ì²´í¬ì¸ ì´í›„)

---

### 4. payments (ê²°ì œ)

```sql
CREATE TABLE payments (
    id BIGSERIAL PRIMARY KEY,
    booking_id BIGINT UNIQUE NOT NULL REFERENCES bookings(id),
    amount DECIMAL(10,2) NOT NULL,
    method VARCHAR(20) NOT NULL,            -- CARD, BANK_TRANSFER, CASH
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING', -- PENDING, PAID, FAILED, REFUNDED
    payment_date TIMESTAMP,
    transaction_id VARCHAR(255)
);
```

**ê²°ì œ ìƒíƒœ**:
- `PENDING`: ê²°ì œ ëŒ€ê¸°
- `PAID`: ê²°ì œ ì™„ë£Œ
- `FAILED`: ê²°ì œ ì‹¤íŒ¨
- `REFUNDED`: í™˜ë¶ˆ ì™„ë£Œ

**âš ï¸ ì¤‘ìš”**: ê²°ì œ ë‚´ì—­ì€ ë²•ì  ì¦ë¹™ ìë£Œì´ë¯€ë¡œ **ì ˆëŒ€ ì‚­ì œë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤**.

**ê´€ê³„**:
- `OneToOne` â†’ `booking` (ì˜ˆì•½)

---

### 5. reviews (ë¦¬ë·°)

```sql
CREATE TABLE reviews (
    id BIGSERIAL PRIMARY KEY,
    user_id VARCHAR(15) NOT NULL REFERENCES users(id),
    room_id BIGINT NOT NULL REFERENCES rooms(id),
    booking_id BIGINT REFERENCES bookings(id),
    rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 5),
    title VARCHAR(255),
    comment TEXT,
    is_public BOOLEAN DEFAULT true,
    admin_reply TEXT,
    admin_reply_date TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**ê´€ê³„**:
- `ManyToOne` â†’ `user` (ì‚¬ìš©ì)
- `ManyToOne` â†’ `room` (ê°ì‹¤)
- `ManyToOne` â†’ `booking` (ì˜ˆì•½)

---

### 6. notices (ê³µì§€ì‚¬í•­)

```sql
CREATE TABLE notices (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    important BOOLEAN DEFAULT false,
    type VARCHAR(20) NOT NULL,              -- NOTICE, EVENT, PROMOTION
    is_public BOOLEAN DEFAULT true,
    start_date DATE,
    end_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

### 7. email_verifications (ì´ë©”ì¼ ì¸ì¦)

```sql
CREATE TABLE email_verifications (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) NOT NULL,
    code VARCHAR(10) NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    verified BOOLEAN DEFAULT false
);
```

**ìš©ë„**: íšŒì›ê°€ì… ë° ê³„ì • ë³µêµ¬ ì‹œ ì´ë©”ì¼ ì¸ì¦

---

## ìƒíƒœ ë³€í™” ì‹œë‚˜ë¦¬ì˜¤

### ê°ì‹¤ ìƒíƒœ ë³€í™”

#### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ ì²´í¬ì¸/ì²´í¬ì•„ì›ƒ

```
1. ì˜ˆì•½ ìƒì„±
   Room.status = CLEAN (ê¸°ë³¸ê°’)
   Booking.status = CONFIRMED

2. ì²´í¬ì¸ ì²˜ë¦¬ (ê´€ë¦¬ì)
   Booking.status = CHECKED_IN
   Room.status = CLEAN (ë³€ê²½ ì—†ìŒ)

3. ì²´í¬ì•„ì›ƒ ì²˜ë¦¬ (ê´€ë¦¬ì)
   Booking.status = CHECKED_OUT
   Room.status = DIRTY (ìë™ ë³€ê²½) âš¡
   Room.statusUpdatedAt = í˜„ì¬ ì‹œê°„

4. ì²­ì†Œ ì™„ë£Œ ì²˜ë¦¬ (ê´€ë¦¬ì)
   Room.status = CLEAN (ìˆ˜ë™ ë³€ê²½)
   Room.statusUpdatedAt = í˜„ì¬ ì‹œê°„
```

#### ì‹œë‚˜ë¦¬ì˜¤ 2: ë³´ìˆ˜ ì‘ì—…

```
1. ê´€ë¦¬ìê°€ ë³´ìˆ˜ ì‹œì‘
   Room.status = MAINTENANCE (ìˆ˜ë™ ë³€ê²½)
   Room.available = true (ë˜ëŠ” false, ì •ì±…ì— ë”°ë¼)

2. ë³´ìˆ˜ ì™„ë£Œ
   Room.status = CLEAN (ìˆ˜ë™ ë³€ê²½)
   Room.available = true
```

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ê°ì‹¤ ë¹„í™œì„±í™”

```
1. ê´€ë¦¬ìê°€ ê°ì‹¤ ë¹„í™œì„±í™”
   Room.available = false
   Room.status = CLEAN (ë˜ëŠ” ë‹¤ë¥¸ ìƒíƒœ, ë…ë¦½ì )

2. ì˜ˆì•½ ë¶ˆê°€ (available = falseì´ë¯€ë¡œ)
   â†’ ì˜ˆì•½ ìƒì„± ì‹œ ì²´í¬í•˜ì—¬ ì°¨ë‹¨
```

---

### ì˜ˆì•½ ìƒíƒœ ë³€í™”

#### ì •ìƒ íë¦„

```
CONFIRMED (ì˜ˆì•½ í™•ì •)
    â†“ [ì²´í¬ì¸ ì²˜ë¦¬]
CHECKED_IN (íˆ¬ìˆ™ ì¤‘)
    â†“ [ì²´í¬ì•„ì›ƒ ì²˜ë¦¬]
CHECKED_OUT (ì²´í¬ì•„ì›ƒ ì™„ë£Œ)
```

#### ì·¨ì†Œ íë¦„

```
CONFIRMED (ì˜ˆì•½ í™•ì •)
    â†“ [ì˜ˆì•½ ì·¨ì†Œ]
CANCELLED (ì·¨ì†Œë¨)
```

**âš ï¸ ì£¼ì˜**: `CHECKED_IN` ìƒíƒœì—ì„œëŠ” ì·¨ì†Œ ë¶ˆê°€ (ì´ë¯¸ ì²´í¬ì¸ ì™„ë£Œ)

---

## ë°ì´í„° ë¬´ê²°ì„± ì •ì±…

### CASCADE ì„¤ì •

**âœ… ëª¨ë“  CASCADE ì œê±°ë¨** (2025-12-06 ìˆ˜ì • ì™„ë£Œ)

**ì´ìœ **:
- ê²°ì œ ë‚´ì—­ì€ ë²•ì  ì¦ë¹™ ìë£Œì´ë¯€ë¡œ ì ˆëŒ€ ì‚­ì œë˜ë©´ ì•ˆ ë¨
- ê³¼ê±° ì˜ˆì•½ ë‚´ì—­ì€ íšŒê³„/í†µê³„ ëª©ì ìœ¼ë¡œ ë³´ì¡´ í•„ìš”
- ì‚¬ìš©ì ì‚­ì œ ì‹œì—ë„ ê³¼ê±° ê±°ë˜ ë‚´ì—­ ë³´ì¡´

**í˜„ì¬ ì„¤ì •**:
```java
// User â†’ Bookings: CASCADE ì—†ìŒ
@OneToMany(mappedBy = "user")
private List<Booking> bookings;

// Booking â†’ Payment: CASCADE ì—†ìŒ
@OneToOne(mappedBy = "booking")
private Payment payment;

// Room â†’ Bookings: CASCADE ì—†ìŒ
@OneToMany(mappedBy = "room")
private List<Booking> bookings;
```

---

## ì¸ë±ìŠ¤ ì „ëµ

### ì£¼ìš” ì¸ë±ìŠ¤

```sql
-- Users
CREATE UNIQUE INDEX idx_users_email ON users(email);

-- Bookings (ì˜ˆì•½ ì¡°íšŒ ìµœì í™”)
CREATE INDEX idx_bookings_user_id ON bookings(user_id);
CREATE INDEX idx_bookings_room_id ON bookings(room_id);
CREATE INDEX idx_bookings_dates ON bookings(check_in_date, check_out_date);
CREATE INDEX idx_bookings_status ON bookings(status);

-- Rooms
CREATE INDEX idx_rooms_status ON rooms(status);
CREATE INDEX idx_rooms_available ON rooms(available);

-- Reviews
CREATE INDEX idx_reviews_room_id ON reviews(room_id);
CREATE INDEX idx_reviews_user_id ON reviews(user_id);
```

---

## ì˜ˆì•½ ì¤‘ë³µ ë°©ì§€

### ì• í”Œë¦¬ì¼€ì´ì…˜ ë ˆë²¨ ì²´í¬

```java
// ê°™ì€ ê°ì‹¤ì˜ ê²¹ì¹˜ëŠ” ë‚ ì§œ ë²”ìœ„ì— ì˜ˆì•½ì´ ìˆëŠ”ì§€ í™•ì¸
@Query("SELECT b FROM Booking b WHERE b.room = :room " +
       "AND b.checkInDate < :checkOutDate AND b.checkOutDate > :checkInDate")
List<Booking> findByRoomAndCheckInDateAndCheckOutDate(...);
```

**ì¡°ê±´**: ì·¨ì†Œë˜ì§€ ì•Šì€ ì˜ˆì•½(`status != CANCELLED`)ë§Œ ì²´í¬

### í–¥í›„ ê°œì„ : DB ì œì•½ì¡°ê±´

```sql
-- PostgreSQL EXCLUDE ì œì•½ì¡°ê±´ (í–¥í›„ êµ¬í˜„)
ALTER TABLE bookings
ADD CONSTRAINT no_overlapping_bookings
EXCLUDE USING gist (
    room_id WITH =,
    daterange(check_in_date, check_out_date) WITH &&
) WHERE (status != 'CANCELLED');
```

---

## ë°ì´í„° ë³´ì¡´ ì •ì±…

### ì‚­ì œ ì •ì±…

| ì—”í‹°í‹° | ì‚­ì œ ê°€ëŠ¥ ì—¬ë¶€ | ë¹„ê³  |
|--------|--------------|------|
| Payment | âŒ ì ˆëŒ€ ì‚­ì œ ë¶ˆê°€ | ë²•ì  ì¦ë¹™ ìë£Œ |
| Booking | âš ï¸ ìƒíƒœ ë³€ê²½ ê¶Œì¥ | ê³¼ê±° ì˜ˆì•½ ë³´ì¡´ |
| Review | âœ… ì‚­ì œ ê°€ëŠ¥ | ë¹„ì¦ˆë‹ˆìŠ¤ ì •ì±…ì— ë”°ë¼ |
| Room | âš ï¸ Soft Delete ê¶Œì¥ | ê³¼ê±° ì˜ˆì•½ ë³´ì¡´ |

---

**ì‘ì„±ì¼**: 2025ë…„ 1ì›”

